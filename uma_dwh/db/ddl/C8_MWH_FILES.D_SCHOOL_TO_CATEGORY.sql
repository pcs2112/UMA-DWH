USE UMA_DWH
GO -- delimiter

-- C8_MWH_FILES.D_SCHOOL_TO_CATEGORY.sql
-- 2019-04-28 16:22
-- Generated by:

/*
select D_CATEGORY_ID, D_CSV_FILE_ID, count(*) from MWH_FILES.D_SCHOOL_TO_CATEGORY with(nolock) group by D_CATEGORY_ID, D_CSV_FILE_ID  order by D_CATEGORY_ID asc, D_CSV_FILE_ID asc


select D_CATEGORY_ID,  count(*) from MWH_FILES.D_SCHOOL_TO_CATEGORY with(nolock) group by D_CATEGORY_ID  order by D_CATEGORY_ID asc

1	8
2	107
3	3049
4	9710
5	10307
6	2121
7	642
8	30174
9	3489
10	102
11	51
12	56
13	1022
14	2

select D_CSV_FILE_ID,  count(*) from MWH_FILES.D_SCHOOL_TO_CATEGORY with(nolock) group by D_CSV_FILE_ID  order by D_CSV_FILE_ID asc
14	15793
19	15791
20	15288
21	13968


*/


/*
IF EXISTS (SELECT * FROM sys.objects so JOIN  sys.schemas ss on (so.schema_id = ss.schema_id) WHERE so.type = 'U' AND so.name = 'D_SCHOOL_TO_CATEGORY' and ss.name = 'MWH_FILES')
	DROP TABLE MWH_FILES.D_SCHOOL_TO_CATEGORY
GO
*/

CREATE TABLE MWH_FILES.D_SCHOOL_TO_CATEGORY(
	[ID] INT NOT NULL IDENTITY (1, 1),
	[INSERT_DTTM] DATETIME CONSTRAINT D_SCHOOL_TO_CATEGORY_INSERT_DTTM_DF DEFAULT getdate () NOT NULL,
	[UPDATE_DTTM] DATETIME CONSTRAINT D_SCHOOL_TO_CATEGORY_UPDATE_DTTM_DF DEFAULT getdate () NOT NULL,
	[LST_MOD_USER] VARCHAR (80) CONSTRAINT D_SCHOOL_TO_CATEGORY_LST_MOD_USER_DF DEFAULT user_name () NOT NULL,
	[MSTR_LOAD_ID] INT CONSTRAINT D_SCHOOL_TO_CATEGORY_MSTR_LOAD_ID_DF DEFAULT (-1)  NULL,
	[ACTIVE_FLAG] SMALLINT CONSTRAINT D_SCHOOL_TO_CATEGORY_ACTIVE_FLG_DF DEFAULT 1 NOT NULL,
	D_CSV_FILE_ID		INTEGER			not null,
	D_CATEGORY_ID		INTEGER			not null,	
	WHERE_UNIT_ID_TABLE	NVARCHAR(256)   not null,
	UNIT_ID				INTEGER			not null				--  UNIT_ID is the PK for schools, from the GOVERNMENT CSV
	CONSTRAINT PK_D_SCHOOL_TO_CATEGORY PRIMARY KEY NONCLUSTERED
	(
		ID ASC
	)
	WITH (
		PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON
	) ON [PRIMARY]
) ON [PRIMARY]
GO -- delimiter



CREATE TRIGGER MWH_FILES.D_SCHOOL_TO_CATEGORY_TRIG
ON MWH_FILES.D_SCHOOL_TO_CATEGORY
AFTER UPDATE
		AS BEGIN
	UPDATE MWH_FILES.D_SCHOOL_TO_CATEGORY
	SET UPDATE_DTTM = GETDATE()
	WHERE ID IN (SELECT DISTINCT ID FROM INSERTED)
END
GO -- delimiter


CREATE  NONCLUSTERED INDEX [D_SCHOOL_TO_CATEGORY_IDX_01]
	ON MWH_FILES.D_SCHOOL_TO_CATEGORY
(
		UNIT_ID ASC
) include (	
		D_CSV_FILE_ID ,
		D_CATEGORY_ID ,
		WHERE_UNIT_ID_TABLE 
) WITH (
	PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON
	) ON [PRIMARY]
GO -- delimiter


CREATE  NONCLUSTERED INDEX [D_SCHOOL_TO_CATEGORY_IDX_02]
	ON MWH_FILES.D_SCHOOL_TO_CATEGORY
(
		D_CSV_FILE_ID ASC
) include (
		UNIT_ID ,
		D_CATEGORY_ID ,
		WHERE_UNIT_ID_TABLE 
) WITH (
	PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON
	) ON [PRIMARY]
GO -- delimiter



CREATE  NONCLUSTERED INDEX [D_SCHOOL_TO_CATEGORY_IDX_03]
	ON MWH_FILES.D_SCHOOL_TO_CATEGORY
(
		D_CATEGORY_ID ASC
		) include (
		D_CSV_FILE_ID ,
		UNIT_ID ,
		WHERE_UNIT_ID_TABLE 		
) WITH (
	PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON
	) ON [PRIMARY]
GO -- delimiter



CREATE  NONCLUSTERED INDEX [D_SCHOOL_TO_CATEGORY_IDX_04]
	ON MWH_FILES.D_SCHOOL_TO_CATEGORY
(
		WHERE_UNIT_ID_TABLE asc,
		D_CATEGORY_ID ASC
) include (
		D_CSV_FILE_ID ,
		UNIT_ID 	
) WITH (
	PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON
	) ON [PRIMARY]
GO -- delimiter
